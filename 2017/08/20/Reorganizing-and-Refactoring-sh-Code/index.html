<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="My life as a coder">
    

    <!--Author-->
    
        <meta name="author" content="Juan David Vega">
    

    <meta property="og:url" content="http://juandavidvega.es/2017/08/20/Reorganizing-and-Refactoring-sh-Code/index.html" />
    <!--Open Graph Title-->
    
        <meta property="og:title" content="Reorganizing and Refactoring on sh"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="My life as a coder" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="My life as a coder"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    
        <meta property="og:image" content="http://juandavidvega.es/images/2017/08/vista-de-cuenca.jpg"/>
    

    <meta property="og:image:width" content="600" /> 
    <meta property="og:image:height" content="315" />

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Reorganizing and Refactoring on sh - My life as a coder</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-78972584-1', 'auto');
        ga('send', 'pageview');

    </script>



</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Juan David Vega Rodríguez</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/headers">
                            
                                Images
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/jdvr">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/images/2017/08/vista-de-cuenca.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Reorganizing and Refactoring on sh</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        20-08-2017
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-tags">
                    
                        

<a href="/categories/Java/">Java</a>/ <a href="/categories/Java/Spring-WebFlux/">Spring WebFlux</a>/ <a href="/categories/Java/Spring-WebFlux/Spring-Data/">Spring Data</a>/ <a href="/categories/Java/Spring-WebFlux/Spring-Data/Mongo/">Mongo</a>/ <a href="/categories/Java/Spring-WebFlux/Spring-Data/Mongo/Reactive-Programming/">Reactive Programming</a>/ <a href="/categories/Java/Spring-WebFlux/Spring-Data/Mongo/Reactive-Programming/Spring-Boot/">Spring Boot</a>/ <a href="/categories/Java/Spring-WebFlux/Spring-Data/Mongo/Reactive-Programming/Spring-Boot/tutorial/">tutorial</a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>During the last week I have been writing a script to manage the instances of a Redis Clusted. The ideas was to copy the features of <a href="https://github.com/antirez/redis/tree/unstable/utils/create-cluster" target="_blank" rel="external">“create-cluster” scripts</a>, to create a production scripts that help us on our daily redis management.</p>
<p>This week I had to write, refactor and organize code in a very different ways. I would like to share some <em>easy steps</em> to make bash scripts easier to read, debug and maintain. I have copied the “create-cluster” script to this <a href="https://github.com/jdvr/create-cluster" target="_blank" rel="external">repository</a> and I going to use it as example. The target script includes this features:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Usage: create-cluster [start|create|stop|watch|tail|clean]</div><div class="line">start       -- Launch Redis Cluster instances.</div><div class="line">create      -- Create a cluster using redis-trib create.</div><div class="line">stop        -- Stop Redis Cluster instances.</div><div class="line">watch       -- Show CLUSTER NODES output (first 30 lines) of first node.</div><div class="line">tail &lt;id&gt;   -- Run tail -f of instance at base port + ID.</div><div class="line">clean       -- Remove all instances data, logs, configs.</div><div class="line">clean-logs  -- Remove just instances logs.</div></pre></td></tr></table></figure>
<p>The script is just one <a href="">file</a>, at the start it loads a default configuration and check if a <code>config.sh</code> file exists, after that there are a lot of <code>if</code> statements  checking which command is requested as parameter and at the end if the parameter doesn’t match any command it prints the help.</p>
<p>I am not going to paste every time the full file during the post to make this more readable, so I am going to just include the changes and a link to the commit.</p>
<h2 id="Refactor-without-tests"><a href="#Refactor-without-tests" class="headerlink" title="Refactor without tests?"></a>Refactor without tests?</h2><p>I think that refactor without test is always a bad idea, you aren’t able to verify if the code has exact the same behavior. How do I solve this? When developing anything over a language with a very good REPL you can use the REPL as a verified. You need to put a little manual effort but doing it slow and step by step will ensure you that the code has still the same behavior after a refactor. After every little focused change I run the “test” on the REPL and commit.</p>
<h2 id="Step-1-Extract-commands-to-functions"><a href="#Step-1-Extract-commands-to-functions" class="headerlink" title="Step 1: Extract commands to functions"></a>Step 1: Extract commands to functions</h2><p>I am going to explain the step by step of the <code>start</code> command and then repeat the same with the others.</p>
<p>The first thing is to extract the relative path to <code>redis-server</code> and remove the relative reference to make easier to move the code:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">redis-<span class="function"><span class="title">server</span></span>() &#123;</div><div class="line">  ../../src/redis-server <span class="variable">$@</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"start"</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">    <span class="keyword">while</span> [ $((PORT &lt; ENDPORT)) != <span class="string">"0"</span> ]; <span class="keyword">do</span></div><div class="line">        PORT=$((PORT+1))</div><div class="line">        <span class="built_in">echo</span> <span class="string">"Starting <span class="variable">$PORT</span>"</span></div><div class="line">        redis-server --port <span class="variable">$PORT</span> --cluster-enabled yes --cluster-config-file nodes-<span class="variable">$&#123;PORT&#125;</span>.conf --cluster-node-timeout <span class="variable">$TIMEOUT</span> --appendonly yes --appendfilename appendonly-<span class="variable">$&#123;PORT&#125;</span>.aof --dbfilename dump-<span class="variable">$&#123;PORT&#125;</span>.rdb --logfile <span class="variable">$&#123;PORT&#125;</span>.<span class="built_in">log</span> --daemonize yes</div><div class="line">    <span class="keyword">done</span></div><div class="line">    <span class="built_in">exit</span> 0</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p><a href="https://github.com/jdvr/create-cluster/commit/c2ecbd3c1995f1fba70f5c0fcfb053e4180df6c4" target="_blank" rel="external">commit</a></p>
<p>I am going to extract the code inside the <code>if</code> statement to a function:  <code>start_command</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">start_command</span></span>() &#123;</div><div class="line">  <span class="keyword">while</span> [ $((PORT &lt; ENDPORT)) != <span class="string">"0"</span> ]; <span class="keyword">do</span></div><div class="line">      PORT=$((PORT+1))</div><div class="line">      <span class="built_in">echo</span> <span class="string">"Starting <span class="variable">$PORT</span>"</span></div><div class="line">      redis-server --port <span class="variable">$PORT</span> --cluster-enabled yes --cluster-config-file nodes-<span class="variable">$&#123;PORT&#125;</span>.conf --cluster-node-timeout <span class="variable">$TIMEOUT</span> --appendonly yes --appendfilename appendonly-<span class="variable">$&#123;PORT&#125;</span>.aof --dbfilename dump-<span class="variable">$&#123;PORT&#125;</span>.rdb --logfile <span class="variable">$&#123;PORT&#125;</span>.<span class="built_in">log</span> --daemonize yes</div><div class="line">  <span class="keyword">done</span></div><div class="line">  <span class="built_in">exit</span> 0</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"start"</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">    start_command</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p><a href="https://github.com/jdvr/create-cluster/commit/384cebee187850d928b25717fd74cf676c944e62" target="_blank" rel="external">commit</a></p>
<p>I follow this two steps with the rest of the commands, check the change <a href="https://github.com/jdvr/create-cluster/commit/7fcbb59a1350d6bbda88747a318df8dd3a93d5df" target="_blank" rel="external">here</a>, so I end with a function for each command a some function to remove relative paths.</p>
<h1 id="Step-2-Extract-functions-to-different-files"><a href="#Step-2-Extract-functions-to-different-files" class="headerlink" title="Step 2: Extract functions to different files"></a>Step 2: Extract functions to different files</h1><p>The next step is to move functions to different files, I am going to create one file for redis general functions:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">redis-functions.sh</div><div class="line"></div><div class="line">redis-<span class="function"><span class="title">server</span></span>() &#123;</div><div class="line">  ../../src/redis-server <span class="variable">$@</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">redis-<span class="function"><span class="title">trib</span></span>() &#123;</div><div class="line">  ../../src/redis-trib.rb <span class="variable">$@</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">redis-<span class="function"><span class="title">cli</span></span>() &#123;</div><div class="line">  ../../src/redis-cli <span class="variable">$@</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Now, I just add <code>source &quot;redis-functions.sh&quot;</code> to main file and everything work.</p>
<p><a href="https://github.com/jdvr/create-cluster/commit/394081d573d328ed79f694e8b721d4eaa8d08fa3" target="_blank" rel="external">commit</a></p>
<p>In the same way I create a file for each command under the directory commands with the name <em>name.command.sh</em> and import it at the start of the main file:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">source</span> other files</div><div class="line"></div><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> $(ls commands); <span class="keyword">do</span> <span class="built_in">source</span> <span class="string">"commands/<span class="variable">$f</span>"</span>; <span class="keyword">done</span></div></pre></td></tr></table></figure>
<p>The new files can be found on this <a href="https://github.com/jdvr/create-cluster/commit/eb7fb837031ef7ff8cb9a2126837c52e2aee29f7" target="_blank" rel="external">commit</a>.</p>
<h1 id="Step-3-Replacing-conditional-with-data-structure"><a href="#Step-3-Replacing-conditional-with-data-structure" class="headerlink" title="Step 3: Replacing conditional with data structure"></a>Step 3: Replacing conditional with data structure</h1><p>After the las two step with have a script that is an interface between the commands and the user, remember how this tool is used: <code>create-cluster [start|stop|create...]</code>. This behavior is archive with a lot of <code>if</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#import files</span></div><div class="line">...</div><div class="line"><span class="comment"># check config</span></div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"start"</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">    start_command</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"create"</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">    create_command</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"stop"</span> ]</div><div class="line"><span class="keyword">then</span></div><div class="line">  stop_command</div><div class="line"><span class="keyword">fi</span></div><div class="line">....</div><div class="line"><span class="comment">#more if's</span></div></pre></td></tr></table></figure>
<p>The easier way to remove this structure is to introduce a map that related the command name with its executor (function):</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">declare</span> -A commands</div><div class="line"></div><div class="line">commands[start]=start_command</div><div class="line">commands[create]=create_command</div><div class="line">commands[stop]=stop_command</div><div class="line">commands[watch]=watch_command</div><div class="line">commands[tail]=tail_command</div><div class="line">commands[call]=call_command</div><div class="line">commands[clean]=clean_command</div><div class="line">commands[clean-logs]=clean_logs_command</div></pre></td></tr></table></figure>
<p>To execute a command, I just need to look up the first argument on the <em>map</em>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$&#123;commands[$1]&#125;</span></div></pre></td></tr></table></figure>
<p>If this fails the next statement are a bunch of <code>echo</code> to print help, otherwise every command ends with a <code>exit 0</code>,  so after execute it the execution ends successfully.</p>
<p>The changed for this step can be found on this <a href="https://github.com/jdvr/create-cluster/commit/22fab6187380f5a0bb6f74c6bf79fae1506f6a79" target="_blank" rel="external">commit</a></p>
<h1 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h1><p>This post just introduce some tips that for me improve and make a bit easier the work of the developer, a big script with hundred or even thousand lines are very difficult to change without introduce a bug. The steps I have followed are just basic knowledge and culture in other languages, we have a strong <em>clean-coder</em> culture and we put a lot of efforts on other languages and platforms, so why shell/bash should be different?.</p>


                
                <hr/>
                <div class="col-lg-12 col-md-12 related-psot">
                    <h5 class="text-center">Más articulos</h5>
                    <div class="col-lg-6 col-md-6">
	
</div>
<div class="col-lg-6 col-md-6">
	
		<a href="/2017/03/05/usando-reactive-programming-con-spring-webflux-y-spring-data/" >Aplicación con Spring WebFlux y Spring Data</a>
	
</div>
                </div>

            </div>

            
            
            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    
    <hr />
    <h3>Comentarios:</h3>
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>



                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                        <li>
                            <a href="https://twitter.com/juandvegarguez" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                        <li>
                            <a href="https://github.com/jdvr" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="https://es.linkedin.com/in/juandavidvegarguez" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                </ul>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted"> <a href="https://github.com/jdvr/hexo-theme-clean-blog" target="_blank">Forked</a> of The Adapted version by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'juandavidvega';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>

</html>